{"version":3,"file":"searchexecutor.cjs","names":[],"sources":["../../../../../../../../../node_modules/.pnpm/couchbase@4.5.0/node_modules/couchbase/dist/searchexecutor.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.SearchExecutor = void 0;\n/* eslint jsdoc/require-jsdoc: off */\nconst bindingutilities_1 = require(\"./bindingutilities\");\nconst searchquery_1 = require(\"./searchquery\");\nconst searchtypes_1 = require(\"./searchtypes\");\nconst streamablepromises_1 = require(\"./streamablepromises\");\n/**\n * @internal\n */\nclass SearchExecutor {\n    /**\n     * @internal\n     */\n    constructor(cluster, bucketName, scopeName) {\n        this._cluster = cluster;\n        this._bucketName = bucketName;\n        this._scopeName = scopeName;\n    }\n    /**\n     * @internal\n     */\n    query(indexName, query, options) {\n        const emitter = new streamablepromises_1.StreamableRowPromise((rows, meta) => {\n            return new searchtypes_1.SearchResult({\n                rows: rows,\n                meta: meta,\n            });\n        });\n        const searchQuery = query instanceof searchquery_1.SearchQuery\n            ? JSON.stringify(query)\n            : query.searchQuery\n                ? JSON.stringify(query.searchQuery)\n                : JSON.stringify(new searchquery_1.MatchNoneSearchQuery());\n        const timeout = options.timeout || this._cluster.searchTimeout;\n        const request = {\n            timeout,\n            index_name: indexName,\n            query: searchQuery,\n            limit: options.limit,\n            skip: options.skip,\n            explain: options.explain || false,\n            disable_scoring: options.disableScoring || false,\n            include_locations: options.includeLocations || false,\n            highlight_style: options.highlight\n                ? (0, bindingutilities_1.searchHighlightStyleToCpp)(options.highlight.style)\n                : undefined,\n            highlight_fields: options.highlight && options.highlight.fields\n                ? options.highlight.fields\n                : [],\n            fields: options.fields || [],\n            collections: options.collections || [],\n            scan_consistency: (0, bindingutilities_1.searchScanConsistencyToCpp)(options.consistency),\n            mutation_state: (0, bindingutilities_1.mutationStateToCpp)(options.consistentWith).tokens,\n            sort_specs: options.sort\n                ? options.sort.map((sort) => JSON.stringify(sort))\n                : [],\n            facets: options.facets\n                ? Object.fromEntries(Object.entries(options.facets)\n                    .filter(([, v]) => v !== undefined)\n                    .map(([k, v]) => [k, JSON.stringify(v)]))\n                : {},\n            raw: options.raw\n                ? Object.fromEntries(Object.entries(options.raw)\n                    .filter(([, v]) => v !== undefined)\n                    .map(([k, v]) => [k, JSON.stringify(v)]))\n                : {},\n            body_str: '',\n            show_request: options.showRequest || false,\n            log_request: options.logRequest || false,\n            log_response: options.logResponse || false,\n        };\n        if (query instanceof searchtypes_1.SearchRequest) {\n            if (query.vectorSearch) {\n                request.vector_search = JSON.stringify(query.vectorSearch.queries);\n                if (query.vectorSearch.options &&\n                    query.vectorSearch.options.vectorQueryCombination) {\n                    request.vector_query_combination = (0, bindingutilities_1.vectorQueryCombinationToCpp)(query.vectorSearch.options.vectorQueryCombination);\n                }\n            }\n        }\n        if (this._bucketName && this._scopeName) {\n            request.bucket_name = this._bucketName;\n            request.scope_name = this._scopeName;\n        }\n        this._cluster.conn.search(request, (cppErr, resp) => {\n            const err = (0, bindingutilities_1.errorFromCpp)(cppErr);\n            if (err) {\n                emitter.emit('error', err);\n                emitter.emit('end');\n                return;\n            }\n            resp.rows.forEach((row) => {\n                row.fields = row.fields ? JSON.parse(row.fields) : undefined;\n                row.explanation = row.explanation\n                    ? JSON.parse(row.explanation)\n                    : undefined;\n                emitter.emit('row', row);\n            });\n            {\n                const metaData = resp.meta;\n                emitter.emit('meta', {\n                    facets: Object.fromEntries(Object.values(resp.facets).map((v) => [v.name, v])),\n                    ...metaData,\n                });\n            }\n            emitter.emit('end');\n            return;\n        });\n        return emitter;\n    }\n}\nexports.SearchExecutor = SearchExecutor;\n"],"x_google_ignoreList":[0],"mappings":"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"}