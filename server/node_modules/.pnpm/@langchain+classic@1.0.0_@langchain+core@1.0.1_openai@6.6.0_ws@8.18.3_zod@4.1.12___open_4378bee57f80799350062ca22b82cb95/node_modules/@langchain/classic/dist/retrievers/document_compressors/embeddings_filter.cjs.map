{"version":3,"file":"embeddings_filter.cjs","names":["BaseDocumentCompressor","cosineSimilarity","params: EmbeddingsFilterParams","documents: DocumentInterface[]","query: string"],"sources":["../../../src/retrievers/document_compressors/embeddings_filter.ts"],"sourcesContent":["import type { EmbeddingsInterface } from \"@langchain/core/embeddings\";\nimport type { DocumentInterface } from \"@langchain/core/documents\";\nimport { cosineSimilarity } from \"@langchain/core/utils/math\";\nimport { BaseDocumentCompressor } from \"./index.js\";\n\n/**\n * Interface for the parameters of the `EmbeddingsFilter` class.\n */\nexport interface EmbeddingsFilterParams {\n  embeddings: EmbeddingsInterface;\n  similarityFn?: (x: number[][], y: number[][]) => number[][];\n  similarityThreshold?: number;\n  k?: number;\n}\n\n/**\n * Class that represents a document compressor that uses embeddings to\n * drop documents unrelated to the query.\n * @example\n * ```typescript\n * const embeddingsFilter = new EmbeddingsFilter({\n *   embeddings: new OpenAIEmbeddings(),\n *   similarityThreshold: 0.8,\n *   k: 5,\n * });\n * const retrievedDocs = await embeddingsFilter.filterDocuments(\n *   getDocuments(),\n *   \"What did the speaker say about Justice Breyer in the 2022 State of the Union?\",\n * );\n * console.log({ retrievedDocs });\n * ```\n */\nexport class EmbeddingsFilter extends BaseDocumentCompressor {\n  /**\n   * Embeddings to use for embedding document contents and queries.\n   */\n  embeddings: EmbeddingsInterface;\n\n  /**\n   * Similarity function for comparing documents.\n   */\n  similarityFn = cosineSimilarity;\n\n  /**\n   * Threshold for determining when two documents are similar enough\n   * to be considered redundant. Must be specified if `k` is not set.\n   */\n  similarityThreshold?: number;\n\n  /**\n   * The number of relevant documents to return. Can be explicitly set to undefined, in which case\n   * similarity_threshold` must be specified. Defaults to 20\n   */\n  k? = 20;\n\n  constructor(params: EmbeddingsFilterParams) {\n    super();\n    this.embeddings = params.embeddings;\n    this.similarityFn = params.similarityFn ?? this.similarityFn;\n    this.similarityThreshold = params.similarityThreshold;\n    this.k = \"k\" in params ? params.k : this.k;\n    if (this.k === undefined && this.similarityThreshold === undefined) {\n      throw new Error(`Must specify one of \"k\" or \"similarity_threshold\".`);\n    }\n  }\n\n  async compressDocuments(\n    documents: DocumentInterface[],\n    query: string\n  ): Promise<DocumentInterface[]> {\n    const embeddedDocuments = await this.embeddings.embedDocuments(\n      documents.map((doc) => doc.pageContent)\n    );\n    const embeddedQuery = await this.embeddings.embedQuery(query);\n    const similarity = this.similarityFn([embeddedQuery], embeddedDocuments)[0];\n    let includedIdxs = Array.from(\n      { length: embeddedDocuments.length },\n      (_, i) => i\n    );\n\n    if (this.k !== undefined) {\n      includedIdxs = includedIdxs\n        .map((v, i) => [similarity[i], v])\n        .sort(([a], [b]) => b - a)\n        .slice(0, this.k)\n        .map(([, i]) => i);\n    }\n\n    if (this.similarityThreshold !== undefined) {\n      const threshold = this.similarityThreshold;\n      includedIdxs = includedIdxs.filter((i) => similarity[i] > threshold);\n    }\n\n    return includedIdxs.map((i) => documents[i]);\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAgCA,IAAa,mBAAb,cAAsCA,qEAAuB;;;;CAI3D;;;;CAKA,eAAeC;;;;;CAMf;;;;;CAMA,IAAK;CAEL,YAAYC,QAAgC;EAC1C,OAAO;EACP,KAAK,aAAa,OAAO;EACzB,KAAK,eAAe,OAAO,gBAAgB,KAAK;EAChD,KAAK,sBAAsB,OAAO;EAClC,KAAK,IAAI,OAAO,SAAS,OAAO,IAAI,KAAK;AACzC,MAAI,KAAK,MAAM,UAAa,KAAK,wBAAwB,OACvD,OAAM,IAAI,MAAM,CAAC,kDAAkD,CAAC;CAEvE;CAED,MAAM,kBACJC,WACAC,OAC8B;EAC9B,MAAM,oBAAoB,MAAM,KAAK,WAAW,eAC9C,UAAU,IAAI,CAAC,QAAQ,IAAI,YAAY,CACxC;EACD,MAAM,gBAAgB,MAAM,KAAK,WAAW,WAAW,MAAM;EAC7D,MAAM,aAAa,KAAK,aAAa,CAAC,aAAc,GAAE,kBAAkB,CAAC;EACzE,IAAI,eAAe,MAAM,KACvB,EAAE,QAAQ,kBAAkB,OAAQ,GACpC,CAAC,GAAG,MAAM,EACX;AAED,MAAI,KAAK,MAAM,QACb,eAAe,aACZ,IAAI,CAAC,GAAG,MAAM,CAAC,WAAW,IAAI,CAAE,EAAC,CACjC,KAAK,CAAC,CAAC,EAAE,EAAE,CAAC,EAAE,KAAK,IAAI,EAAE,CACzB,MAAM,GAAG,KAAK,EAAE,CAChB,IAAI,CAAC,GAAG,EAAE,KAAK,EAAE;AAGtB,MAAI,KAAK,wBAAwB,QAAW;GAC1C,MAAM,YAAY,KAAK;GACvB,eAAe,aAAa,OAAO,CAAC,MAAM,WAAW,KAAK,UAAU;EACrE;AAED,SAAO,aAAa,IAAI,CAAC,MAAM,UAAU,GAAG;CAC7C;AACF"}