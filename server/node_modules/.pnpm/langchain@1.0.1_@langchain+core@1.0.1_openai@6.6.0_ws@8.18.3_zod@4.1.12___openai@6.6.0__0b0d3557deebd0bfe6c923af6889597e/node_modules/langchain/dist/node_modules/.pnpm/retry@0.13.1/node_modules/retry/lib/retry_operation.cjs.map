{"version":3,"file":"retry_operation.cjs","names":[],"sources":["../../../../../../../../../node_modules/.pnpm/retry@0.13.1/node_modules/retry/lib/retry_operation.js"],"sourcesContent":["function RetryOperation(timeouts, options) {\n  // Compatibility for the old (timeouts, retryForever) signature\n  if (typeof options === 'boolean') {\n    options = { forever: options };\n  }\n\n  this._originalTimeouts = JSON.parse(JSON.stringify(timeouts));\n  this._timeouts = timeouts;\n  this._options = options || {};\n  this._maxRetryTime = options && options.maxRetryTime || Infinity;\n  this._fn = null;\n  this._errors = [];\n  this._attempts = 1;\n  this._operationTimeout = null;\n  this._operationTimeoutCb = null;\n  this._timeout = null;\n  this._operationStart = null;\n  this._timer = null;\n\n  if (this._options.forever) {\n    this._cachedTimeouts = this._timeouts.slice(0);\n  }\n}\nmodule.exports = RetryOperation;\n\nRetryOperation.prototype.reset = function() {\n  this._attempts = 1;\n  this._timeouts = this._originalTimeouts.slice(0);\n}\n\nRetryOperation.prototype.stop = function() {\n  if (this._timeout) {\n    clearTimeout(this._timeout);\n  }\n  if (this._timer) {\n    clearTimeout(this._timer);\n  }\n\n  this._timeouts       = [];\n  this._cachedTimeouts = null;\n};\n\nRetryOperation.prototype.retry = function(err) {\n  if (this._timeout) {\n    clearTimeout(this._timeout);\n  }\n\n  if (!err) {\n    return false;\n  }\n  var currentTime = new Date().getTime();\n  if (err && currentTime - this._operationStart >= this._maxRetryTime) {\n    this._errors.push(err);\n    this._errors.unshift(new Error('RetryOperation timeout occurred'));\n    return false;\n  }\n\n  this._errors.push(err);\n\n  var timeout = this._timeouts.shift();\n  if (timeout === undefined) {\n    if (this._cachedTimeouts) {\n      // retry forever, only keep last error\n      this._errors.splice(0, this._errors.length - 1);\n      timeout = this._cachedTimeouts.slice(-1);\n    } else {\n      return false;\n    }\n  }\n\n  var self = this;\n  this._timer = setTimeout(function() {\n    self._attempts++;\n\n    if (self._operationTimeoutCb) {\n      self._timeout = setTimeout(function() {\n        self._operationTimeoutCb(self._attempts);\n      }, self._operationTimeout);\n\n      if (self._options.unref) {\n          self._timeout.unref();\n      }\n    }\n\n    self._fn(self._attempts);\n  }, timeout);\n\n  if (this._options.unref) {\n      this._timer.unref();\n  }\n\n  return true;\n};\n\nRetryOperation.prototype.attempt = function(fn, timeoutOps) {\n  this._fn = fn;\n\n  if (timeoutOps) {\n    if (timeoutOps.timeout) {\n      this._operationTimeout = timeoutOps.timeout;\n    }\n    if (timeoutOps.cb) {\n      this._operationTimeoutCb = timeoutOps.cb;\n    }\n  }\n\n  var self = this;\n  if (this._operationTimeoutCb) {\n    this._timeout = setTimeout(function() {\n      self._operationTimeoutCb();\n    }, self._operationTimeout);\n  }\n\n  this._operationStart = new Date().getTime();\n\n  this._fn(this._attempts);\n};\n\nRetryOperation.prototype.try = function(fn) {\n  console.log('Using RetryOperation.try() is deprecated');\n  this.attempt(fn);\n};\n\nRetryOperation.prototype.start = function(fn) {\n  console.log('Using RetryOperation.start() is deprecated');\n  this.attempt(fn);\n};\n\nRetryOperation.prototype.start = RetryOperation.prototype.try;\n\nRetryOperation.prototype.errors = function() {\n  return this._errors;\n};\n\nRetryOperation.prototype.attempts = function() {\n  return this._attempts;\n};\n\nRetryOperation.prototype.mainError = function() {\n  if (this._errors.length === 0) {\n    return null;\n  }\n\n  var counts = {};\n  var mainError = null;\n  var mainErrorCount = 0;\n\n  for (var i = 0; i < this._errors.length; i++) {\n    var error = this._errors[i];\n    var message = error.message;\n    var count = (counts[message] || 0) + 1;\n\n    counts[message] = count;\n\n    if (count >= mainErrorCount) {\n      mainError = error;\n      mainErrorCount = count;\n    }\n  }\n\n  return mainError;\n};\n"],"x_google_ignoreList":[0],"mappings":"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"}